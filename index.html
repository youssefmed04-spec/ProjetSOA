<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>TP4 - Interface Personnes</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 1.3em;
        }
        
        .section {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .method {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
            min-width: 70px;
            text-align: center;
        }
        
        .get { background: #27ae60; }
        .post { background: #2980b9; }
        .put { background: #f39c12; }
        .delete { background: #e74c3c; }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 5px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.delete-btn {
            background: #e74c3c;
        }
        
        button.delete-btn:hover {
            background: #c0392b;
        }
        
        .person-list {
            margin-top: 20px;
        }
        
        .person-item {
            background: white;
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .person-info {
            flex-grow: 1;
        }
        
        .person-actions {
            display: flex;
            gap: 10px;
        }
        
        .person-id {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .person-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .person-age {
            color: #7f8c8d;
            margin-left: 10px;
        }
        
        .action-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .load-btn {
            background: #2ecc71;
            margin-bottom: 15px;
        }
        
        .load-btn:hover {
            background: #27ae60;
        }
        
        .status {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .success {
            background: #d5edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Gestion des Personnes - TP4 JAX-RS</h1>
        
        <div class="debug-info">
            <strong>API URL:</strong> <span id="apiUrl"></span> |
            <strong>Statut:</strong> <span id="apiStatus">Non test√©</span>
        </div>
        
        <!-- Section 1: Liste des personnes -->
        <div class="section">
            <h2><span class="method get">GET</span> Liste des personnes</h2>
            <button class="load-btn" onclick="loadPersons()">
                üîÑ Charger toutes les personnes
            </button>
            
            <div id="personList" class="person-list">
                <!-- La liste sera charg√©e ici -->
            </div>
        </div>
        
        <!-- Section 2: Ajouter une personne -->
        <div class="section">
            <h2><span class="method post">POST</span> Ajouter une personne</h2>
            <div class="form-group">
                <label for="addName">Nom:</label>
                <input type="text" id="addName" placeholder="Entrez le nom">
            </div>
            <div class="form-group">
                <label for="addAge">√Çge:</label>
                <input type="number" id="addAge" placeholder="Entrez l'√¢ge">
            </div>
            <button onclick="addPerson()">‚ûï Ajouter</button>
        </div>
        
        <!-- Section 3: Rechercher par ID -->
        <div class="section">
            <h2><span class="method get">GET</span> Rechercher par ID</h2>
            <div class="form-group">
                <label for="searchId">ID de la personne:</label>
                <input type="number" id="searchId" placeholder="Entrez l'ID">
            </div>
            <button onclick="getPersonById()">üîç Rechercher</button>
            
            <div id="searchResult" class="person-item" style="display:none; margin-top:15px;">
                <div class="person-info">
                    <span class="person-id" id="resultId"></span>
                    <span class="person-name" id="resultName"></span>
                    <span class="person-age" id="resultAge"></span>
                </div>
                <div class="person-actions">
                    <button class="action-btn" onclick="editPerson()">‚úèÔ∏è Modifier</button>
                    <button class="action-btn delete-btn" onclick="deleteSearchResult()">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Modifier une personne -->
        <div class="section">
            <h2><span class="method put">PUT</span> Modifier une personne</h2>
            <div class="form-group">
                <label for="editId">ID:</label>
                <input type="number" id="editId" placeholder="ID √† modifier">
            </div>
            <div class="form-group">
                <label for="editName">Nouveau nom:</label>
                    <input type="text" id="editName" placeholder="Nouveau nom">
            </div>
            <div class="form-group">
                <label for="editAge">Nouvel √¢ge:</label>
                <input type="number" id="editAge" placeholder="Nouvel √¢ge">
            </div>
            <button onclick="updatePerson()">üíæ Mettre √† jour</button>
        </div>
        
        <!-- Section 5: Supprimer une personne -->
        <div class="section">
            <h2><span class="method delete">DELETE</span> Supprimer une personne</h2>
            <div class="form-group">
                <label for="deleteId">ID √† supprimer:</label>
                <input type="number" id="deleteId" placeholder="Entrez l'ID">
            </div>
            <button class="delete-btn" onclick="confirmDelete()">üóëÔ∏è Supprimer</button>
        </div>
        
        <!-- Messages de statut -->
        <div id="statusMessage" class="status"></div>
    </div>

    <script>
        // CORRECTION IMPORTANTE : URL de l'API
        const API_URL = 'http://localhost:8080/ProjetSOA/api/persons';
        
        // Afficher l'URL de l'API
        document.getElementById('apiUrl').textContent = API_URL;
        
        // Fonction pour √©chapper les caract√®res HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Afficher un message de statut
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Tester la connexion √† l'API
        async function testAPI() {
            try {
                const response = await fetch(API_URL);
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = 'Connect√©';
                    document.getElementById('apiStatus').style.color = 'green';
                    return true;
                } else {
                    document.getElementById('apiStatus').textContent = 'Erreur ' + response.status;
                    document.getElementById('apiStatus').style.color = 'red';
                    return false;
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Erreur de connexion';
                document.getElementById('apiStatus').style.color = 'red';
                return false;
            }
        }
        
        // 1. Charger toutes les personnes
        async function loadPersons() {
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error('Erreur HTTP ' + response.status);
                }
                
                const persons = await response.json();
                console.log('Donn√©es re√ßues:', persons);
                
                const listDiv = document.getElementById('personList');
                listDiv.innerHTML = '';
                
                if (!persons || persons.length === 0) {
                    listDiv.innerHTML = '<div class="person-item">Aucune personne trouv√©e</div>';
                    showStatus('Base de donn√©es vide', 'success');
                    return;
                }
                
                // G√©rer diff√©rents formats de donn√©es
                let personsArray = persons;
                if (!Array.isArray(persons)) {
                    for (const key in persons) {
                        if (Array.isArray(persons[key])) {
                            personsArray = persons[key];
                            break;
                        }
                    }
                }
                
                // Cr√©er les √©l√©ments person par person
                personsArray.forEach(person => {
                    const id = person.id || person.ID || person.personId || 0;
                    const name = person.name || person.nom || person.personName || 'Sans nom';
                    const age = person.age || person.ageValue || person.personAge || 0;
                    
                    // Cr√©er l'√©l√©ment principal
                    const personDiv = document.createElement('div');
                    personDiv.className = 'person-item';
                    
                    // Cr√©er la div d'information
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'person-info';
                    
                    const idSpan = document.createElement('span');
                    idSpan.className = 'person-id';
                    idSpan.textContent = 'ID: ' + id;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'person-name';
                    nameSpan.textContent = name;
                    
                    const ageSpan = document.createElement('span');
                    ageSpan.className = 'person-age';
                    ageSpan.textContent = age + ' ans';
                    
                    infoDiv.appendChild(idSpan);
                    infoDiv.appendChild(nameSpan);
                    infoDiv.appendChild(ageSpan);
                    
                    // Cr√©er la div d'actions
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'person-actions';
                    
                    // Bouton Modifier
                    const modifyBtn = document.createElement('button');
                    modifyBtn.className = 'action-btn';
                    modifyBtn.textContent = 'Modifier';
                    modifyBtn.onclick = function() {
                        fillEditForm(id, name, age);
                    };
                    
                    // Bouton Supprimer
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn delete-btn';
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.onclick = function() {
                        deletePersonById(id);
                    };
                    
                    actionsDiv.appendChild(modifyBtn);
                    actionsDiv.appendChild(deleteBtn);
                    
                    // Assembler tout
                    personDiv.appendChild(infoDiv);
                    personDiv.appendChild(actionsDiv);
                    
                    listDiv.appendChild(personDiv);
                });
                
                showStatus('‚úÖ ' + personsArray.length + ' personne(s) charg√©e(s)', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('‚ùå Erreur lors du chargement: ' + error.message, 'error');
            }
        }
        
        // 2. Ajouter une personne
        async function addPerson() {
            const name = document.getElementById('addName').value.trim();
            const age = document.getElementById('addAge').value;
            
            if (!name || !age) {
                showStatus('‚ö†Ô∏è Veuillez remplir tous les champs', 'error');
                return;
            }
            
            const person = { 
                name: name, 
                age: parseInt(age) 
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(person)
                });
                
                console.log('R√©ponse POST:', response.status);
                
                if (response.ok || response.status === 201) {
                    showStatus('‚úÖ Personne ajout√©e avec succ√®s', 'success');
                    document.getElementById('addName').value = '';
                    document.getElementById('addAge').value = '';
                    loadPersons();
                } else {
                    const errorText = await response.text();
                    showStatus('‚ùå Erreur lors de l\'ajout: ' + response.status + ' - ' + errorText, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erreur r√©seau: ' + error.message, 'error');
            }
        }
        
        // 3. Rechercher une personne par ID
        async function getPersonById() {
            const id = document.getElementById('searchId').value.trim();
            
            if (!id) {
                showStatus('‚ö†Ô∏è Veuillez entrer un ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(API_URL + '/' + id);
                
                if (response.ok) {
                    const person = await response.json();
                    console.log('Personne trouv√©e:', person);
                    
                    const personId = person.id || person.ID || person.personId;
                    const personName = person.name || person.nom || person.personName || 'Sans nom';
                    const personAge = person.age || person.ageValue || person.personAge || 0;
                    
                    document.getElementById('resultId').textContent = 'ID: ' + personId;
                    document.getElementById('resultName').textContent = personName;
                    document.getElementById('resultAge').textContent = personAge + ' ans';
                    document.getElementById('searchResult').style.display = 'flex';
                    
                    document.getElementById('editId').value = personId;
                    document.getElementById('editName').value = personName;
                    document.getElementById('editAge').value = personAge;
                    
                    showStatus('‚úÖ Personne trouv√©e', 'success');
                } else if (response.status === 404) {
                    showStatus('‚ùå Personne non trouv√©e avec l\'ID ' + id, 'error');
                    document.getElementById('searchResult').style.display = 'none';
                } else {
                    const errorText = await response.text();
                    showStatus('‚ùå Erreur serveur: ' + response.status + ' - ' + errorText, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Remplir le formulaire d'√©dition
        function fillEditForm(id, name, age) {
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editAge').value = age;
            document.getElementById('searchId').value = id;
            getPersonById();
        }
        
        // 4. Modifier une personne
        async function updatePerson() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value.trim();
            const age = document.getElementById('editAge').value;
            
            if (!id || !name || !age) {
                showStatus('‚ö†Ô∏è Veuillez remplir tous les champs', 'error');
                return;
            }
            
            const person = { 
                id: parseInt(id),
                name: name,
                age: parseInt(age)
            };
            
            console.log('Envoi de modification:', person);
            
            try {
                const response = await fetch(API_URL + '/' + id, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(person)
                });
                
                console.log('R√©ponse PUT:', response.status);
                
                if (response.ok) {
                    showStatus('‚úÖ Personne modifi√©e avec succ√®s', 'success');
                    loadPersons();
                    
                    const currentSearchId = document.getElementById('searchId').value;
                    if (currentSearchId === id) {
                        getPersonById();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Erreur d√©taill√©e:', errorText);
                    showStatus('‚ùå Erreur lors de la modification: ' + response.status + ' - ' + errorText, 'error');
                }
            } catch (error) {
                console.error('Erreur compl√®te:', error);
                showStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // 5. Supprimer une personne
        async function confirmDelete() {
            const id = document.getElementById('deleteId').value.trim();
            
            if (!id) {
                showStatus('‚ö†Ô∏è Veuillez entrer un ID', 'error');
                return;
            }
            
            if (confirm('Voulez-vous vraiment supprimer la personne avec l\'ID ' + id + ' ?')) {
                await deletePersonById(id);
                document.getElementById('deleteId').value = '';
            }
        }
        
        // Supprimer par ID
        async function deletePersonById(id) {
            if (!confirm('Voulez-vous vraiment supprimer la personne ID ' + id + ' ?')) {
                return;
            }
            
            try {
                const response = await fetch(API_URL + '/' + id, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('R√©ponse DELETE:', response.status);
                
                if (response.ok) {
                    showStatus('‚úÖ Personne supprim√©e avec succ√®s', 'success');
                    
                    const resultId = document.getElementById('resultId').textContent.replace('ID: ', '');
                    if (resultId === id.toString()) {
                        document.getElementById('searchResult').style.display = 'none';
                    }
                    
                    loadPersons();
                } else {
                    const errorText = await response.text();
                    showStatus('‚ùå Erreur lors de la suppression: ' + response.status + ' - ' + errorText, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }
        
        // Supprimer le r√©sultat de recherche
        async function deleteSearchResult() {
            const id = document.getElementById('resultId').textContent.replace('ID: ', '');
            await deletePersonById(id);
            document.getElementById('searchResult').style.display = 'none';
        }
        
        // Fonction pour modifier depuis le r√©sultat de recherche
        function editPerson() {
            const id = document.getElementById('resultId').textContent.replace('ID: ', '');
            const name = document.getElementById('resultName').textContent;
            const age = document.getElementById('resultAge').textContent.replace(' ans', '');
            
            fillEditForm(id, name, age);
        }
        
        // Initialisation
        window.addEventListener('load', async function() {
            console.log('Initialisation...');
            const connected = await testAPI();
            if (connected) {
                loadPersons();
            } else {
                showStatus('‚ùå Impossible de se connecter √† l\'API. V√©rifiez que le serveur est d√©marr√©.', 'error');
            }
        });
    </script>
</body>
</html>